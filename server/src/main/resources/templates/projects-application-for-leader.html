<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>íŒ€ ë¹Œë“œ â€“ ë¦¬ë”ìš©</title>
    <style>
        :root {
            --col-pos: 140px; /* í¬ì§€ì…˜ ë¼ë²¨ í­ */
            --col-cap: 110px; /* capacity ì…ë ¥ í­ */
            --col-btn: 84px; /* ë²„íŠ¼ í­ */
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            margin: 24px;
        }

        h2 {
            margin: 12px 0;
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        input[type="text"], input[type="number"] {
            padding: 6px 8px;
            width: 100%;
        }

        button {
            padding: 6px 10px;
            cursor: pointer;
            width: 100%;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 8px;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        th {
            background: #f5f5f5;
        }

        .muted {
            color: #666;
            font-size: 13px;
        }

        .section {
            margin-top: 24px;
        }

        .pill {
            display: inline-block;
            padding: 2px 6px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 2px;
            font-size: 12px;
        }

        .ok {
            color: #0b7;
        }

        .err {
            color: #c00;
            white-space: pre-wrap;
        }

        .help {
            font-size: 12px;
            color: #555;
        }

        .sticky {
            position: sticky;
            top: 0;
            background: white;
            padding-top: 8px;
        }

        /* ===== í¬ì§€ì…˜ ì…ë ¥ ì˜ì—­: 4ì—´ ê³ ì • (ê²¹ì¹¨ ë°©ì§€) ===== */
        .positions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pos-row {
            display: grid;
            grid-template-columns: var(--col-pos) var(--col-cap) 1fr var(--col-btn);
            gap: 10px;
            align-items: center;
        }

        .pos-label {
            font-weight: 700;
            white-space: nowrap;
        }

        .cap-wrap {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cap-note {
            font-size: 11px;
            color: #777;
            text-align: left;
        }

        .ids-wrap {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .ids-input {
            width: 100%;
        }

        .hint {
            min-height: 18px;
        }

        .auto-btn {
            white-space: nowrap;
        }

        @media (max-width: 820px) {
            /* ì‘ì€ í™”ë©´: ë‘ ì¤„ë¡œ ì ‘ê¸° */
            .pos-row {
                grid-template-columns: var(--col-pos) 1fr;
            }

            .cap-wrap {
                grid-column: 2 / 3;
                max-width: 200px;
            }

            .ids-wrap {
                grid-column: 1 / 3;
            }

            .auto-btn {
                grid-column: 2 / 3;
                width: 120px;
                justify-self: end;
            }
        }
    </style>
</head>
<body>

<h2>ëª¨ì§‘í•˜ê¸° í˜ì´ì§€</h2>

<!-- í”„ë¡œì íŠ¸ ì„ íƒ -->
<div class="section sticky">
    <div class="row">
        <label for="projectId"><b>í”„ë¡œì íŠ¸ ID</b></label>
        <input id="projectId" type="number" placeholder="ì˜ˆ) 1" style="max-width:120px"/>
        <button id="loadBtn" type="button" style="width:auto">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <span id="projectTitle" class="muted"></span>
    </div>
    <div class="help">* ë³¸ì¸ì´ ë“±ë¡í•œ í”„ë¡œì íŠ¸ì˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
</div>

<!-- ì§€ì›ì í‘œ -->
<div class="section">
    <h3>ì‹ ì²­ì ëª©ë¡</h3>
    <div class="help"> ë³¸ì¸ì˜ íŒ€ì— ì§€ì›í•œ ì‹ ì²­ìë“¤ì˜ ëª©ë¡ì…ë‹ˆë‹¤.</div>
    <table id="appliesTable">
        <colgroup>
            <col style="width:15%">
            <col style="width:15%">
            <col style="width:15%">
            <col style="width:55%">
        </colgroup>
        <thead>
        <tr>
            <th>ìœ ì € ID</th>
            <th>ì´ë¦„</th>
            <th>ë¶„ì•¼</th>
            <th>ì½”ë©˜íŠ¸</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td colspan="4" class="muted">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”. ì‹ ì²­ì ëª©ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</td>
        </tr>
        </tbody>
    </table>
    <div id="applySummary" class="muted"></div>
</div>

<!-- ì„ ë°œ ì…ë ¥ -->
<div class="section">
    <h3>ì„ ë°œ ì…ë ¥ (ìš°ì„ ìˆœì„œëŒ€ë¡œ IDë¥¼ ì½¤ë§ˆë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•´ì£¼ì„¸ìš”.)</h3>
    <div class="help">
        * ëª¨ì§‘ì„ í¬ë§í•˜ëŠ” ë¶„ì•¼ì— ì›í•˜ëŠ” ì¸ì›ìˆ˜ë§Œí¼ capacityë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br/>
        * ë³¸ì¸ì˜ í”„ë¡œì íŠ¸ì—ì„œ ëª¨ì§‘í•˜ì§€ ì•ŠëŠ” ë¶„ì•¼ëŠ” capacityê°€ 0ì¸ì±„ë¡œ ë³´ë‚´ì£¼ì„¸ìš”.<br/>
        * ìë™ ì±„ì›€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í•´ë‹¹ ë¶„ì•¼ ì§€ì›ì IDë¥¼ <b>ì˜¤ë¦„ì°¨ìˆœ</b>ìœ¼ë¡œ ì±„ì›Œì¤ë‹ˆë‹¤.
    </div>

    <div class="positions" id="positionList"></div>

    <div class="row" style="margin-top:16px;">
        <button id="submitBtn" type="button" style="width:auto">í¬ë§ íŒ€ ì œì¶œí•˜ê¸°</button>
        <span id="submitMsg" class="muted"></span>
    </div>
</div>

<script th:inline="javascript">
    // ========================
    // ğŸ”‘ ì„œë²„ì—ì„œ ë°›ì€ authToken
    // ========================
    const authToken = /*[[${authToken} ?: '']]*/ '';
    const authHeaders = authToken ? {'Authorization': 'Bearer ' + authToken} : {};

    // ========================
    // UI & ë¡œì§
    // ========================
    const POSITIONS = ["FRONTEND", "BACKEND", "AI", "DESIGN", "ANDROID", "IOS", "PM", "GAME"];
    const list = document.getElementById('positionList');

    // í¬ì§€ì…˜ ì¤„ ìƒì„± (4ì—´ ê³ ì •)
    POSITIONS.forEach(pos => {
        const row = document.createElement('div');
        row.className = 'pos-row';
        row.innerHTML = `
      <div class="pos-label">${pos}</div>

      <div class="cap-wrap">
        <input id="cap_${pos}" type="number" min="0" value="0"/>
        <div class="cap-note">capacity</div>
      </div>

      <div class="ids-wrap">
        <input id="ids_${pos}" class="ids-input" type="text" placeholder="ì˜ˆ) 1000,1001"/>
        <div id="hint_${pos}" class="muted hint">ì‹ ì²­ì ì—†ìŒ</div>
      </div>

      <button type="button" class="auto-btn" data-autofill="${pos}">ìë™ ì±„ì›€</button>
    `;
        list.appendChild(row);
    });

    let currentProjectId = null;
    let lastApplies = [];

    function renderAppliesTable(applies) {
        const tbody = document.querySelector('#appliesTable tbody');
        tbody.innerHTML = '';
        if (!applies || applies.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="muted">ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            document.getElementById('applySummary').textContent = '';
            return;
        }
        for (const it of applies) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
        <td>${it.applicantId ?? ''}</td>
        <td>${it.applicantName ?? ''}</td>
        <td>${it.position ?? ''}</td>
        <td style="text-align:left">${(it.comment ?? '').replaceAll('<', '&lt;')}</td>
      `;
            tbody.appendChild(tr);
        }
        // ë¶„ì•¼ë³„ ìš”ì•½
        const counts = POSITIONS.map(p => {
            const n = applies.filter(a => a.position === p).length;
            return n ? `${p} ${n}` : null;
        }).filter(Boolean).join(', ');
        document.getElementById('applySummary').textContent = `ì´ ${applies.length}ëª…` + (counts ? ` Â· ë¶„ì•¼ë³„: ${counts}` : '');
        updateHints();
    }

    function groupByPosition(applies) {
        const m = {};
        POSITIONS.forEach(p => m[p] = []);
        for (const a of applies) {
            if (m[a.position]) m[a.position].push(a);
        }
        POSITIONS.forEach(p => m[p].sort((x, y) => (x.applicantId ?? 0) - (y.applicantId ?? 0)));
        return m;
    }

    function updateHints() {
        const g = groupByPosition(lastApplies);
        POSITIONS.forEach(p => {
            const ids = g[p].map(x => x.applicantId);
            const el = document.getElementById(`hint_${p}`);
            el.innerHTML = ids.length
                ? 'ì‹ ì²­ì: ' + ids.map(id => `<span class="pill">${id}</span>`).join('')
                : 'ì‹ ì²­ì ì—†ìŒ';
        });
    }

    // ìë™ ì±„ì›€
    document.addEventListener('click', e => {
        const pos = e.target?.dataset?.autofill;
        if (!pos) return;
        const g = groupByPosition(lastApplies);
        document.getElementById(`ids_${pos}`).value = g[pos].map(x => x.applicantId).join(',');
    });

    // ë¶ˆëŸ¬ì˜¤ê¸°
    document.getElementById('loadBtn').addEventListener('click', async () => {
        const pid = Number(document.getElementById('projectId').value);
        if (!pid) {
            alert('í”„ë¡œì íŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        try {
            const res = await fetch(`/team-build/${pid}/applies`, {headers: {'Accept': 'application/json', ...authHeaders}});
            const json = await res.json();
            if (!res.ok || !json.success) throw new Error(json.message || 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
            currentProjectId = pid;
            lastApplies = json.applies || [];
            document.getElementById('projectTitle').textContent = json.projectTitle ? `Â· ${json.projectTitle}` : '';
            renderAppliesTable(lastApplies);
        } catch (err) {
            currentProjectId = null;
            lastApplies = [];
            renderAppliesTable([]);
            alert('[ì—ëŸ¬] ' + (err?.message || err));
        }
    });

    // ì œì¶œ
    document.getElementById('submitBtn').addEventListener('click', async () => {
        if (!currentProjectId) {
            alert('ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.');
            return;
        }
        const roasters = [];
        for (const pos of POSITIONS) {
            const cap = Number(document.getElementById(`cap_${pos}`).value || 0);
            const ids = (document.getElementById(`ids_${pos}`).value.trim() || '')
                .split(',').map(s => s.trim()).filter(Boolean).map(Number).filter(n => !isNaN(n));
            if (cap > 0 || ids.length > 0) {
                roasters.push({position: pos, capacity: cap, applicantIds: ids});
            }
        }
        if (roasters.length === 0) {
            alert('ìµœì†Œ í•œ ê°œ í¬ì§€ì…˜ì€ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }
        const payload = {projectId: currentProjectId, roasters};
        try {
            const res = await fetch('/team-build/preference', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Accept': 'application/json', ...authHeaders},
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            if (!res.ok || !json.success) throw new Error(json.message || 'ë“±ë¡ ì‹¤íŒ¨');
            document.getElementById('submitMsg').innerHTML =
                `<span class="ok">[ì„±ê³µ] íŒ€ êµ¬ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. projectId=${json.projectId}</span>`;
        } catch (err) {
            document.getElementById('submitMsg').innerHTML =
                `<span class="err">[ì‹¤íŒ¨] ${err?.message || err}</span>`;
        }
    });
</script>
</body>
</html>