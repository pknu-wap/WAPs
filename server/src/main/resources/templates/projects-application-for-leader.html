<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>팀 빌드 – 리더용</title>
    <style>
        :root {
            --col-pos: 140px;
            --col-cap: 110px;
            --col-btn: 84px;
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            margin: 24px
        }

        h2 {
            margin: 12px 0
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px
        }

        input[type="text"], input[type="number"], select {
            padding: 6px 8px;
            width: 100%
        }

        button {
            padding: 6px 10px;
            cursor: pointer;
            width: 100%
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 8px;
            table-layout: fixed
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center
        }

        th {
            background: #f5f5f5
        }

        .muted {
            color: #666;
            font-size: 13px
        }

        .section {
            margin-top: 24px
        }

        .pill {
            display: inline-block;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 2px;
            font-size: 12px;
            background: #fff;
            cursor: grab;
            user-select: none;
            transition: .2s;
            position: relative
        }

        .pill:hover {
            background: #f0f8ff;
            border-color: #06c
        }

        .pill.dragging {
            opacity: .5;
            cursor: grabbing
        }

        .pill.drag-over {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, .1)
        }

        .ok {
            color: #0b7
        }

        .err {
            color: #c00;
            white-space: pre-wrap
        }

        .help {
            font-size: 12px;
            color: #555
        }

        .sticky {
            position: sticky;
            top: 0;
            background: #fff;
            padding-top: 8px
        }

        .positions {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .pos-row {
            display: grid;
            grid-template-columns:var(--col-pos) var(--col-cap) 1fr var(--col-btn);
            gap: 10px;
            align-items: center
        }

        .pos-label {
            font-weight: 700;
            white-space: nowrap
        }

        .cap-wrap {
            display: flex;
            flex-direction: column;
            gap: 4px
        }

        .cap-note {
            font-size: 11px;
            color: #777;
            text-align: left
        }

        .priority-area {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .priority-candidates {
            min-height: 80px;
            padding: 12px;
            border: 2px solid #06c;
            border-radius: 8px;
            background: #f8fcff;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: flex-start;
            align-content: flex-start;
            transition: .2s
        }

        .priority-candidates.drag-over {
            border-color: #0056b3;
            background: #e6f3ff;
            box-shadow: 0 0 10px rgba(0, 102, 204, 0.3);
        }

        .priority-candidates:empty::before {
            content: "해당 분야에 지원자가 없습니다";
            color: #999;
            font-style: italic;
            font-size: 12px
        }

        .auto-btn {
            white-space: nowrap
        }

        .capacity-info {
            font-size: 11px;
            color: #666;
            margin-top: 4px
        }

        .priority-pill {
            background: linear-gradient(135deg, #e6f3ff 0%, #cce7ff 100%);
            border-color: #06c;
            color: #0056b3;
            font-weight: 600;
        }

        .priority-pill::after {
            content: " #" attr(data-priority);
            font-size: 10px;
            opacity: .8;
            font-weight: bold;
            background: #06c;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 4px;
        }

        .filter-section {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap
        }

        .filter-label {
            font-weight: 600;
            white-space: nowrap
        }

        .filter-select {
            max-width: 150px;
            flex-shrink: 0
        }

        .position-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #fff;
            background: #666
        }

        .position-badge.FRONTEND {
            background: #ff6b35
        }

        .position-badge.BACKEND {
            background: #4a90e2
        }

        .position-badge.AI {
            background: #7b68ee
        }

        .position-badge.DESIGN {
            background: #ff69b4
        }

        .position-badge.APP {
            background: #32cd32
        }

        .position-badge.EMBEDDED {
            background: #ffa500
        }

        .position-badge.GAME {
            background: #dc143c
        }

        .table-row-highlight {
            background: #fff3cd !important;
            border: 2px solid #ffc107 !important;
            box-shadow: 0 0 10px rgba(255, 193, 7, .5) !important;
            transition: .3s
        }

        .table-row-highlight td {
            background: #fff3cd !important
        }

        @media (max-width: 820px) {
            .pos-row {
                grid-template-columns:var(--col-pos) 1fr
            }

            .cap-wrap {
                grid-column: 2/3;
                max-width: 200px
            }

            .priority-area {
                grid-column: 1/3
            }

            .auto-btn {
                grid-column: 2/3;
                width: 120px;
                justify-self: end
            }
        }

        .topbar {
            display: flex;
            align-items: center;
            margin-bottom: 12px
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #fff;
            color: var(--text);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer
        }

        .back-btn:hover {
            filter: brightness(.98);
            border-color: #d4d7dd
        }

        .back-btn .arrow {
            font-size: 1rem;
            line-height: 1
        }

        /* capacity=0 잠금 표시 */
        .priority-candidates.locked {
            position: relative;
            pointer-events: none;
            opacity: .6
        }

        .priority-candidates.locked::after {
            content: "capacity를 먼저 조절해주세요.";
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, .9);
            color: #c00;
            font-weight: 700;
            border: 2px dashed #c00;
            border-radius: 6px;
            pointer-events: none;
        }

        .priority-info {
            font-size: 11px;
            color: #0056b3;
            font-weight: 600;
            margin-top: 4px;
        }

        /* 우선순위가 설정되지 않은 지원자 스타일 */
        .unranked-pill {
            background: #f5f5f5;
            border-color: #ccc;
            color: #666;
        }

    </style>
</head>
<body>
<div class="topbar">
    <button type="button" class="back-btn" onclick="goBack()"><span class="arrow">←</span> 뒤로가기</button>
</div>

<h2>모집하기 페이지</h2>

<div class="section sticky">
    <div class="row">
        <label for="projectId"><b>프로젝트 ID</b></label>
        <input id="projectId" type="number" placeholder="예) 1" style="max-width:120px"/>
        <button id="loadBtn" type="button" style="width:auto">불러오기</button>
        <span id="projectTitle" class="muted"></span>
    </div>
    <div class="help">* 본인이 등록한 프로젝트의 ID를 입력하세요.</div>
</div>

<div class="section">
    <h3>신청자 목록</h3>
    <div class="help">본인의 팀에 지원한 신청자들의 목록입니다.</div>

    <div class="filter-section">
        <span class="filter-label">분야별 필터:</span>
        <select id="positionFilter" class="filter-select">
            <option value="">전체 보기</option>
            <option value="FRONTEND">FRONTEND</option>
            <option value="BACKEND">BACKEND</option>
            <option value="AI">AI</option>
            <option value="DESIGN">DESIGN</option>
            <option value="APP">APP</option>
            <option value="GAME">GAME</option>
            <option value="EMBEDDED">EMBEDDED</option>
        </select>
        <span id="filterInfo" class="muted"></span>
    </div>

    <table id="appliesTable">
        <colgroup>
            <col style="width:25%">
            <col style="width:25%">
            <col style="width:50%">
        </colgroup>
        <thead>
        <tr>
            <th>이름</th>
            <th>분야</th>
            <th>코멘트</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td colspan="3" class="muted">프로젝트를 불러오세요. 신청자 목록이 나타납니다.</td>
        </tr>
        </tbody>
    </table>
    <div id="applySummary" class="muted"></div>
</div>

<div class="section">
    <h3>우선순위 설정 (드래그 앤 드롭으로 모든 지원자의 우선순위를 정하세요)</h3>
    <div class="help">
        * 모집을 희망하는 분야에 원하는 인원수만큼 capacity를 입력하세요.<br/>
        * 해당 분야의 모든 지원자를 드래그하여 우선순위를 정해주세요. (1순위부터 마지막 순위까지)<br/>
        * capacity가 0이면 우선순위를 설정할 수 없습니다.
    </div>

    <div class="positions" id="positionList"></div>

    <div class="row" style="margin-top:16px;">
        <button id="submitBtn" type="button" style="width:auto">희망 팀 제출하기</button>
        <span id="submitMsg" class="muted"></span>
    </div>
</div>

<script th:inline="javascript">
    /* 서버에서 주입된 토큰 */
    const authToken = /*[[${authToken}]]*/ '';
    const authHeaders = authToken && authToken !== 'null' && authToken.trim() !== ''
        ? {Authorization: 'Bearer ' + authToken}
        : {};

    const POSITIONS = ["FRONTEND", "BACKEND", "AI", "DESIGN", "APP", "EMBEDDED", "GAME"];
    const list = document.getElementById('positionList');

    const priorityCandidates = {};
    POSITIONS.forEach(p => priorityCandidates[p] = []);

    // 포지션 섹션 만들기
    POSITIONS.forEach(pos => {
        const row = document.createElement('div');
        row.className = 'pos-row';
        row.innerHTML = `
      <div class="pos-label">${pos}</div>
      <div class="cap-wrap">
        <input id="cap_${pos}" type="number" min="0" value="0"/>
        <div class="cap-note">capacity</div>
      </div>
      <div class="priority-area">
        <div>우선순위 설정 (1순위 → 마지막순위):</div>
        <div id="priority_${pos}" class="priority-candidates" data-position="${pos}"></div>
        <div class="priority-info" id="info_${pos}"></div>
      </div>`;
        list.appendChild(row);
    });

    let currentProjectId = null;
    let lastApplies = [];
    let currentFilter = '';

    // DnD 상태
    let draggedCandidate = null;
    let draggedIndex = -1;

    // 테이블 하이라이트
    function highlightTableRow(applicantId) {
        document.querySelectorAll('.table-row-highlight').forEach(r => r.classList.remove('table-row-highlight'));
        document.querySelectorAll('#appliesTable tbody tr').forEach(tr => {
            if (tr.dataset.applicantId === String(applicantId)) tr.classList.add('table-row-highlight');
        });
    }

    function removeTableRowHighlight() {
        document.querySelectorAll('.table-row-highlight').forEach(r => r.classList.remove('table-row-highlight'));
    }

    function makeDraggable(el, candidate, index = -1) {
        el.draggable = true;
        el.dataset.candidateId = candidate.applicantId;
        el.dataset.candidateName = candidate.applicantName;
        el.dataset.position = candidate.position;

        el.addEventListener('mouseenter', () => highlightTableRow(candidate.applicantId));
        el.addEventListener('mouseleave', removeTableRowHighlight);

        el.addEventListener('dragstart', (e) => {
            draggedCandidate = candidate;
            draggedIndex = index;
            el.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            removeTableRowHighlight();
        });

        el.addEventListener('dragend', () => {
            el.classList.remove('dragging');
            draggedCandidate = null;
            draggedIndex = -1;
        });

        // 다른 pill 위에 드롭하여 순서 변경
        el.addEventListener('dragover', (e) => {
            if (draggedCandidate && draggedCandidate.position === candidate.position) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                el.classList.add('drag-over');
            }
        });

        el.addEventListener('dragleave', () => el.classList.remove('drag-over'));

        el.addEventListener('drop', (e) => {
            if (!(draggedCandidate && draggedCandidate.position === candidate.position)) return;
            e.preventDefault();
            el.classList.remove('drag-over');

            const position = candidate.position;
            const targetIndex = priorityCandidates[position].findIndex(c => c.applicantId === candidate.applicantId);

            if (draggedIndex !== -1 && targetIndex !== -1 && draggedIndex !== targetIndex) {
                const [moved] = priorityCandidates[position].splice(draggedIndex, 1);
                priorityCandidates[position].splice(targetIndex, 0, moved);
                updatePositionDisplay(position);
            }
        });
    }

    function setupDropZone(container, position) {
        container.addEventListener('dragover', (e) => {
            if (draggedCandidate && draggedCandidate.position === position) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                container.classList.add('drag-over');
            }
        });

        container.addEventListener('dragleave', (e) => {
            if (!container.contains(e.relatedTarget)) container.classList.remove('drag-over');
        });

        container.addEventListener('drop', (e) => {
            e.preventDefault();
            container.classList.remove('drag-over');

            // capacity=0이면 드롭 금지
            const cap = Number(document.getElementById(`cap_${position}`).value || 0);
            if (cap === 0) {
                alert('capacity=0 상태에서는 해당 포지션에 우선순위를 설정할 수 없습니다.');
                return;
            }

            if (!draggedCandidate || draggedCandidate.position !== position) return;

            // 이미 있는지 확인
            const isAlreadyIn = priorityCandidates[position]
                .some(c => c.applicantId === draggedCandidate.applicantId);

            if (!isAlreadyIn) {
                // 새로 추가 - 마지막에 추가
                priorityCandidates[position].push(draggedCandidate);
                updatePositionDisplay(position);
            }
        });
    }

    function updatePositionDisplay(position) {
        const container = document.getElementById(`priority_${position}`);
        const infoDiv = document.getElementById(`info_${position}`);
        const cap = Number(document.getElementById(`cap_${position}`).value || 0);

        // 해당 포지션의 모든 지원자
        const posApps = lastApplies.filter(a => a.position === position);

        // 우선순위 목록 초기화
        if (priorityCandidates[position].length === 0) {
            // 처음 로드시 모든 지원자를 기본 순서로 추가
            priorityCandidates[position] = [...posApps];
        }

        // 우선순위 목록 표시
        container.innerHTML = '';

        if (cap === 0) {
            container.classList.add('locked');
        } else {
            container.classList.remove('locked');
        }

        priorityCandidates[position].forEach((c, idx) => {
            const pill = document.createElement('span');
            pill.className = 'pill priority-pill';
            pill.textContent = c.applicantName;
            pill.title = `ID: ${c.applicantId} (우선순위: ${idx + 1})`;
            pill.dataset.priority = idx + 1;
            makeDraggable(pill, c, idx);
            container.appendChild(pill);
        });

        // 정보 표시
        const totalCount = posApps.length;
        const rankedCount = priorityCandidates[position].length;

        if (totalCount === 0) {
            infoDiv.textContent = '지원자 없음';
            infoDiv.style.color = '#666';
        } else if (cap === 0) {
            infoDiv.textContent = `지원자 ${totalCount}명 (capacity=0이므로 우선순위 설정 불가)`;
            infoDiv.style.color = '#c00';
        } else {
            infoDiv.textContent = `총 ${totalCount}명 우선순위 설정됨 (capacity: ${cap}/${totalCount}명)`;
            infoDiv.style.color = '#0b7';
        }
    }

    function getFilteredApplies() {
        return currentFilter ? lastApplies.filter(a => a.position === currentFilter) : lastApplies;
    }

    function updateFilterInfo() {
        const filtered = getFilteredApplies();
        const info = document.getElementById('filterInfo');
        if (!currentFilter) {
            info.textContent = '';
            return;
        }
        info.textContent = `${currentFilter} 분야: ${filtered.length}명`;
    }

    function renderAppliesTable(applies) {
        const tbody = document.querySelector('#appliesTable tbody');
        tbody.innerHTML = '';
        const filtered = getFilteredApplies();

        if (!filtered || filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" class="muted">${currentFilter ? `${currentFilter} 분야에 신청자가 없습니다.` : '신청자가 없습니다.'}</td></tr>`;
            document.getElementById('applySummary').textContent = '';
            updateFilterInfo();
            return;
        }

        for (const it of filtered) {
            const tr = document.createElement('tr');
            tr.dataset.applicantId = it.applicantId;
            tr.innerHTML = `
        <td>${it.applicantName ?? ''}</td>
        <td><span class="position-badge ${it.position ?? ''}">${it.position ?? ''}</span></td>
        <td style="text-align:left">${(it.comment ?? '').replaceAll('<', '&lt;')}</td>`;
            tbody.appendChild(tr);
        }

        if (!currentFilter) {
            const counts = POSITIONS.map(p => {
                const n = applies.filter(a => a.position === p).length;
                return n ? `${p} ${n}` : null;
            }).filter(Boolean).join(', ');
            document.getElementById('applySummary').textContent = `총 ${applies.length}명` + (counts ? ` · 분야별: ${counts}` : '');
        } else {
            document.getElementById('applySummary').textContent = '';
        }

        updateFilterInfo();

        // 모든 포지션 업데이트 (지원자들을 우선순위 영역에 표시)
        POSITIONS.forEach(pos => {
            updatePositionDisplay(pos);
            setupDropZone(document.getElementById(`priority_${pos}`), pos);
        });
    }

    document.getElementById('positionFilter').addEventListener('change', e => {
        currentFilter = e.target.value;
        renderAppliesTable(lastApplies);
    });

    // 불러오기
    document.getElementById('loadBtn').addEventListener('click', async () => {
        const pid = Number(document.getElementById('projectId').value);
        if (!pid) {
            alert('프로젝트 ID를 입력하세요.');
            return;
        }
        try {
            const res = await fetch(`/team-build/${pid}/applies`, {headers: {Accept: 'application/json', ...authHeaders}});
            const json = await res.json();
            if (!res.ok || !json.success) throw new Error(json.message || '불러오기 실패');

            currentProjectId = pid;
            lastApplies = json.applies || [];
            // 우선순위 초기화
            POSITIONS.forEach(p => priorityCandidates[p] = []);
            document.getElementById('positionFilter').value = '';
            currentFilter = '';
            document.getElementById('projectTitle').textContent = json.projectTitle ? `· ${json.projectTitle}` : '';
            renderAppliesTable(lastApplies);
        } catch (err) {
            currentProjectId = null;
            lastApplies = [];
            currentFilter = '';
            renderAppliesTable([]);
            alert('[에러] ' + (err?.message || err));
        }
    });

    // 제출
    document.getElementById('submitBtn').addEventListener('click', async () => {
        if (!currentProjectId) {
            alert('먼저 프로젝트를 불러오세요.');
            return;
        }

        // 우선순위 검증
        const incomplete = validatePriorityBeforeSubmit();
        if (incomplete.length > 0) {
            const msgLines = incomplete.map(g =>
                `• ${g.pos}: 전체 ${g.total}명 중 ${g.ranked}명만 우선순위 설정됨`
            );
            alert(
                '모집(capacity > 0) 포지션의 모든 지원자에게 우선순위를 설정해야 제출할 수 있습니다.\n\n' +
                msgLines.join('\n')
            );
            return;
        }

        const roasters = [];
        for (const pos of POSITIONS) {
            let cap = Number(document.getElementById(`cap_${pos}`).value || 0);
            let applicantIds = priorityCandidates[pos].map(c => c.applicantId);

            // capacity 값 보정: 음수면 0, 지원자 수보다 크면 지원자 수로 제한
            const maxCap = applicantIds.length;
            if (cap < 0) {
                cap = 0;
            } else if (cap > maxCap) {
                cap = maxCap;
            }
            if (cap === 0) {
                applicantIds = []
            }

            // UI의 입력값도 보정된 값으로 업데이트
            const capInput = document.getElementById(`cap_${pos}`);
            if (Number(capInput.value) !== cap) {
                capInput.value = cap;
            }

            roasters.push({position: pos, capacity: cap, applicantIds});
        }

        try {
            const res = await fetch('/team-build/preference', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', Accept: 'application/json', ...authHeaders},
                body: JSON.stringify({projectId: currentProjectId, roasters})
            });
            const json = await res.json();
            if (!res.ok || !json.success) throw new Error(json.message || '등록 실패');
            document.getElementById('submitMsg').innerHTML = `<span class="ok">[성공] 팀 구성이 완료되었습니다. projectId=${json.projectId}</span>`;
            window.history.go(-2);
        } catch (err) {
            document.getElementById('submitMsg').innerHTML = `<span class="err">[실패] ${err?.message || err}</span>`;
        }
    });

    function goBack() {
        window.history.go(-2);
    }

    // capacity 규칙: 음수 금지 + 0이면 드래그 잠금
    function enforceCapacityRules(pos) {
        const capInput = document.getElementById(`cap_${pos}`);
        let cap = Number(capInput.value || 0);
        if (cap < 0) {
            cap = 0;
            capInput.value = 0;
        }
        const total = totalApplicantsOf(pos);
        if (cap > total) {
            cap = total;
            capInput.value = total;
        }

        // capacity 변경시 화면 업데이트
        updatePositionDisplay(pos);
    }

    POSITIONS.forEach(pos => {
        const capInput = document.getElementById(`cap_${pos}`);
        capInput.addEventListener('input', () => enforceCapacityRules(pos));
        capInput.addEventListener('change', () => enforceCapacityRules(pos)); // change 이벤트도 추가
        enforceCapacityRules(pos); // 초기 상태 반영
    });

    /** 특정 포지션의 전체 지원자 수 */
    function totalApplicantsOf(pos) {
        return (lastApplies || []).filter(a => a.position === pos).length;
    }

    /**
     * 제출 전 검증:
     * cap > 0 인 포지션은 "들어온 모든 지원자"의 우선순위를 설정해야 함.
     * 반환값: 미완 목록 [{pos, total, ranked}]
     */
    function validatePriorityBeforeSubmit() {
        const missing = [];
        for (const pos of POSITIONS) {
            const cap = Number(document.getElementById(`cap_${pos}`).value || 0);
            if (cap <= 0) continue;

            const total = totalApplicantsOf(pos);
            const ranked = (priorityCandidates[pos] || []).length;

            if (total > 0 && ranked !== total) {
                missing.push({pos, total, ranked});
            }
        }
        return missing;
    }

</script>
</body>
</html>